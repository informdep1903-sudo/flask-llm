from flask_sqlalchemy import SQLAlchemy
import openai
import dotenv

# Загружаем переменные окружения из файла .env
env = dotenv.dotenv_values(".env")

# Инициализируем SQLAlchemy для работы с базой данных через Flask
db = SQLAlchemy()


class ChatHistory(db.Model):
    """
    Модель SQLAlchemy для хранения истории общения пользователя с LLM.

    Атрибуты:
        id (int): Уникальный идентификатор записи.
        user_message (str): Сообщение пользователя.
        llm_reply (str): Ответ языковой модели.
        timestamp (datetime): Время создания записи.
    """
    id = db.Column(db.Integer, primary_key=True)  # Уникальный идентификатор
    user_message = db.Column(db.Text, nullable=False)  # Текст сообщения пользователя
    llm_reply = db.Column(db.Text, nullable=False)  # Ответ модели
    timestamp = db.Column(db.DateTime, server_default=db.func.now())  # Временная метка создания записи


def dummy_llm_service(user_message):
    """
    Заглушка для сервиса LLM.

    Аргументы:
        user_message (str): Сообщение пользователя.

    Возвращает:
        str: Стандартный ответ, имитирующий работу LLM.
    """
    return f"Вы сказали: {user_message}, но я пока не могу ответить на это."


class LLMService:
    """
    Класс для взаимодействия с внешней языковой моделью (например, YandexGPT).

    Атрибуты:
        sys_prompt (str): Системный промпт для LLM.
        client: Клиент OpenAI для обращения к API.
        model (str): Идентификатор используемой LLM модели.
    """
    def __init__(self, sys_prompt):
        """
        Инициализация сервиса LLM.

        Аргументы:
            sys_prompt (str): Системный промпт для LLM.
        """
        try:
            # Создаём клиента OpenAI с вашим API-ключом и базовым URL
            self.client = openai.OpenAI(
                api_key=env["YA_API_KEY"],
                base_url="https://llm.api.cloud.yandex.net/v1",
            )
            # Сохраняем системный промпт
            self.sys_prompt = sys_prompt
            # Формируем путь к модели с использованием идентификатора каталога из .env
            self.model = f"gpt://{env['YA_FOLDER_ID']}/yandexgpt-lite"

        except Exception as e:
            print(f"Произошла ошибка: {str(e)}")

    def chat(self, message):
        """
        Отправляет сообщение к языковой модели и возвращает её ответ.

        Аргументы:
            message (str): Сообщение пользователя.

        Возвращает:
            str: Ответ языковой модели или сообщение об ошибке.
        """
        try:
            # Выполняем запрос к API языковой модели
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": self.sys_prompt},
                    {"role": "user", "content": message},
                ],
                temperature=1.0,      # Параметр креативности
                max_tokens=1024,      # Максимальная длина ответа
            )

            # Возвращаем текст ответа модели
            return response.choices[0].message.content

        except Exception as e:
            # В случае ошибки возвращаем её описание
            return f"Произошла ошибка: {str(e)}"

sys_prompt_1 = """
Ты оператор техподдержки, отвечай вежливо. 
Контекст - информация о тарифах домашнего интернета:
### 1. Базовый тариф
* **Скорость:** до 100 Мбит/с
* **Тип подключения:** FTTB
* **Стоимость:** от 500 рублей/месяц
* **Особенности:**
  * Безлимитный интернет
  * Подходит для повседневного использования
  * Оптимален для одного пользователя
  * Просмотр видео в стандартном качестве

### 2. Семейный тариф
* **Скорость:** до 300 Мбит/с
* **Тип подключения:** FTTB
* **Стоимость:** от 700 рублей/месяц
* **Особенности:**
  * Безлимитный интернет
  * Подключение до 5 устройств
  * Одновременный просмотр видео
  * Загрузка файлов со средней скоростью

### 3. Премиум-тариф
* **Скорость:** до 500 Мбит/с
* **Тип подключения:** FTTB
* **Стоимость:** от 900 рублей/месяц
* **Особенности:**
  * Безлимитный интернет
  * Мгновенная загрузка контента
  * Поддержка 4K-видео
  * Подходит для большой семьи

### 4. Игровой тариф
* **Скорость:** до 890 Мбит/с
* **Тип подключения:** FTTB
* **Стоимость:** от 950 рублей/месяц
* **Особенности:**
  * Минимальная задержка
  * Приоритетный трафик для игр
  * Бонусы от игровых платформ
  * Стабильное соединение

### 5. Гигабитный тариф
* **Скорость:** до 1000 Мбит/с
* **Тип подключения:** FTTB
* **Стоимость:** от 1040 рублей/месяц
* **Особенности:**
  * Максимальная скорость передачи данных
  * Идеален для стримеров
  * Быстрая загрузка больших файлов
  * Поддержка множества устройств одновременно

"""


llm_1 = LLMService(sys_prompt_1)


def chat_with_llm(user_message):
    """
    Чат с использованием сервиса LLM.

    Аргументы:
        user_message (str): Сообщение пользователя.

    Возвращает:
        str: Ответ LLM.
    """
    response = llm_1.chat(user_message)
    return response
